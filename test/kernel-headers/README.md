The kernel header tests are primarily used to verify that, for various Linux distributions and kernel versions, the kernel-collector has access to the kernel headers necessary to successfully build and load the eBPF code.  They can also be used as a basic kernel-collector sanity test, to validate that, for a given distro/kernel version, the kernel-collector can successfully start up to the point where it is able to compile and load the eBPF code and send the reducer telemetry.

Pre-requisites:
---------------
- `vagrant`, `virtualbox` and `docker` must be installed on the host
- `vagrant-virtualbox` engine must be installed
- `vagrant` plugins `vagrant-scp` and `vagrant-sshfs` must be installed
- run `benv` and build the kernel collector and reducer docker images with `../build.sh pipeline-docker-registry`
- these tests expect a few environment variables to be present in the host where they are run:
  - [optional] `EBPF_NET_AGENT_NAMESPACE`, `EBPF_NET_AGENT_CLUSTER`, `EBPF_NET_AGENT_SERVICE`, `EBPF_NET_AGENT_HOST`, `EBPF_NET_AGENT_ZONE`, to override the corresponding labels for this agent

One-time set up steps to run tests manually:
-------------------------------------------
- generate tests for a given distro_name/distro_version pair by running:

    `./bootstrap.sh <distro_name> <distro_version> <optional-kernel-version>`
    For example,
    `./bootstrap.sh ubuntu focal64`
    or
    `./bootstrap.sh ubuntu focal64 5.13.0-52-generic`

- alternatively, run `./gen-tests.sh` to generate tests for a well known list of distros specified in the `distros-and-kernels.sh` file.

Running tests manually:
----------------------
Enter the directory named `distro_name-distro_version[-kernel-version]`, generated by the set up step for each test case. Within this directory:

  - run numbered scripts in order, they are:
    - `0-setup.sh`: cleans up any previous VMs, starts a fresh VM and gets it ready to run tests. This step doesn't need to be repeated for multiple runs of the agent tests, even if the reducer must be restarted;
    - `1-start-reducer.sh`: starts the reducer for agents to connect to. This step doesn't need to be repeated for multiple runs of the agent tests;
    - `2-apply-selinux-policy.sh`: optional, for VMs with SELinux enabled, apply a SELinux security policy to allow eBPF operations required by the agent
    - `3-fetch.sh`: ensures that kernel headers are not installed on the VM and that no cached kernel headers are available, then run the agent so it has to fetch kernel headers for the running kernel;
    - `4-cached.sh`: runs the agent without any checks to existing or cached kernel headers. When run after a successful `fetch` step, the VM will contain no pre-installed kernel headers and a valid cached kernel header that the agent can then retrieve;
    - `5-pre-installed.sh`: removes any kernel headers previously cached by the agent and ensures kernel headers are installed on the VM, then runs agent so it can use pre-installed headers;
    - `6-cleanup.sh`: tears down the VM and removes any temporary files.

  - for the `fetch`, `cached` and `pre-installed` steps, verify that the agent's binary is called with the expected kernel headers source, e.g.:

      exec /srv/kernel-collector --host-distro centos --kernel-headers-source [fetched | pre_fetched | pre_installed]

  - verify that the agent connects to the reducer and that it reaches the "Telemetry is flowing" message, at which point you can move to the next numbered script

Automatically run all test steps for a given distro and kernel version:
----------------------------------------------------------------------
    `./run-test.sh <distro_name> <distro_version> <optional-kernel-version>`
    For example,
    `./run-test.sh ubuntu focal64`
    or
    `./run-test.sh ubuntu focal64 5.13.0-52-generic`

Automatically run all steps for a set of well known distros and kernel versions:
-------------------------------------------------------------------------------
    `./run-tests.sh`
    This will run each step of the kernel header tests on each distro and kernel version specified in the `distros-and-kernels.sh` file and will output test results to a date-stamped directory in /tmp.

Develop and test cycle:
-----------------------
A common scenarion is to make changes to the agent / kernel fetching scripts and re-run either the `fetch`, `cached` or `pre-installed` test steps.

That requires rebuilding the agent image and pushing it to the local docker registry, so it becomes available to the test VM. Note that the `0-setup`, `1-start-reducer` and optional `2-apply-selinux-policy` steps don't need to be re-run if only the agent has changed.

The above can be accomplished within `benv` by running `../build.sh` on the targets that build and push docker images to the local docker registry. To list the available targets, run:
```
make help | grep '-docker-registry$'
```

